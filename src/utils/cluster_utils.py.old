"""
Utility functions for cluster operations.
"""
from typing import Optional
import socket
import logging
import dns.resolver
import dns.exception
from src.config import config

logger = logging.getLogger(__name__)


class ClusterValidator:
    """Utility class for cluster validation."""

    CLUSTER_PREFIX = "ocp4-"

    @staticmethod
    def validate_cluster_name(cluster_name: str) -> str:
        """
        Validate and normalize cluster name.
        
        Args:
            cluster_name: The cluster name to validate
            
        Returns:
            Normalized cluster name (lowercase, stripped)
            
        Raises:
            ValueError: If cluster name doesn't start with 'ocp4-'
        """
        cluster_name_lower = cluster_name.lower().strip()
        
        if not cluster_name_lower.startswith(ClusterValidator.CLUSTER_PREFIX):
            raise ValueError(
                f"Cluster name '{cluster_name}' must start with '{ClusterValidator.CLUSTER_PREFIX}' prefix"
            )
        
        return cluster_name_lower

    @staticmethod
    def is_valid_cluster_name(cluster_name: str) -> bool:
        """
        Check if cluster name is valid (starts with 'ocp4-').
        
        Args:
            cluster_name: The cluster name to check
            
        Returns:
            True if valid, False otherwise
        """
        try:
            ClusterValidator.validate_cluster_name(cluster_name)
            return True
        except ValueError:
            return False


class ClusterUtils:
    """Utility class for cluster operations."""

    @staticmethod
    def generate_console_url(cluster_name: str, domain_name: Optional[str] = None) -> str:
        """
        Generate OpenShift console URL for a cluster.
        
        Args:
            cluster_name: The cluster name
            domain_name: Optional domain name (defaults to config value)
            
        Returns:
            Console URL string
        """
        if domain_name is None:
            domain_name = config.default_domain
        
        cluster_name_lower = cluster_name.lower().strip()
        return f"https://console-openshift-console.apps.{cluster_name_lower}.{domain_name}"

    @staticmethod
    def normalize_cluster_name(cluster_name: str) -> str:
        """
        Normalize cluster name to lowercase and strip whitespace.

        Args:
            cluster_name: The cluster name to normalize

        Returns:
            Normalized cluster name
        """
        return cluster_name.lower().strip()

    @staticmethod
    def resolve_loadbalancer_ip(cluster_name: str, domain_name: Optional[str] = None) -> Optional[str]:
        """
        Resolve LoadBalancer IP address by performing DNS lookup using the configured resolution path.
        Uses the configured DNS server and resolution path template from config.

        Args:
            cluster_name: The cluster name
            domain_name: Optional domain name (defaults to config value)

        Returns:
            IP address string or None if resolution fails
        """
        if domain_name is None:
            domain_name = config.default_domain

        cluster_name_lower = cluster_name.lower().strip()

        # Use the configurable DNS resolution path template
        hostname = config.dns_resolution_path.format(
            cluster_name=cluster_name_lower,
            domain_name=domain_name
        )

        try:
            # Create a custom DNS resolver with specific DNS server
            resolver = dns.resolver.Resolver()
            resolver.nameservers = [config.dns_server]
            resolver.timeout = config.dns_timeout
            resolver.lifetime = config.dns_timeout

            # Perform DNS lookup for A record
            answers = resolver.resolve(hostname, 'A')

            if answers:
                ip_address = str(answers[0])
                logger.debug(f"Resolved {hostname} to {ip_address} using DNS server {config.dns_server}")
                return ip_address
            else:
                logger.debug(f"No A records found for {hostname}")
                return None

        except dns.resolver.NXDOMAIN:
            logger.debug(f"DNS name does not exist: {hostname}")
            return None
        except dns.resolver.NoAnswer:
            logger.debug(f"No answer from DNS for: {hostname}")
            return None
        except dns.resolver.Timeout:
            logger.debug(f"DNS lookup timeout for {hostname} (timeout: {config.dns_timeout}s)")
            return None
        except dns.exception.DNSException as e:
            logger.debug(f"DNS error resolving {hostname}: {e}")
            return None
        except Exception as e:
            logger.warning(f"Unexpected error resolving {hostname}: {e}")
            return None

